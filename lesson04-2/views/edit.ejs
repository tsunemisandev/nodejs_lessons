<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit</title>
</head>

<form>
    <p>Title</p>
    <input type="text" id="title" value="">
    <p>Content</p>
    <textarea id="content" rows="10" cols="50"></textarea>
    <br>
    <button type="button" onclick="edit()">編集完了</button>
    <div id='message'></div>
</form>

<body>

    <script>
        //Get postId parameter
        const params = new URLSearchParams(window.location.search);
        const postId = params.get('postId');
        //Get post information
        const req = new XMLHttpRequest();
        req.open('GET', '/post/' + postId);
        req.send();
        //Bind post value
        req.onload = () => {
            const json = JSON.parse(req.response);
            if (req.status == 200) {
                //Parse response
                //Get title
                const title = json.post.title;
                //Get content
                const content = json.post.content;
                const titleTxt = document.getElementById('title');
                const contentTxt = document.getElementById('content');

                titleTxt.value = title;
                contentTxt.value = content;

            } else {
                //Show error message
                const message = document.getElementById('message');
                const errorMessage = json.error;
                message.innerHTML = errorMessage;
            }
        };
        function edit() {
            const titleTxt = document.getElementById('title');
            const contentTxt = document.getElementById('content');
            const title = titleTxt.value;
            const content = contentTxt.value;
            //Create json
            const post = {
                title,
                content,
                id: postId
            }
            //Create request
            const req = new XMLHttpRequest();
            //Set url
            req.open('PUT', '/post/edit')
            //Create header
            req.setRequestHeader('Content-type', 'application/json');
            //Send req
            req.send(JSON.stringify(post));
            //Show ok message
            req.onload = () => {
                const message = document.getElementById('message');
                if (req.status == 204) {
                    //Redirect to list page
                    window.location = '/post';
                } else {
                    let msg = '';
                    const errorMsg = JSON.parse(req.response);
                    if (errorMsg.errors) {
                        errorMsg.errors.forEach(error => {
                            let paramName = error.param;
                            if (paramName === 'title') {
                                msg += 'Title:' + error.msg + '<br>'
                            } else if (paramName === 'content') {
                                msg += 'Content:' + error.msg + '<br>'
                            }
                        });
                    } else if (errorMsg.error) {
                        msg += errorMsg.error;
                    }
                    const messageTxt = document.getElementById('message');
                    messageTxt.innerHTML = msg;
                }
            }
        }
    </script>
</body>

</html>